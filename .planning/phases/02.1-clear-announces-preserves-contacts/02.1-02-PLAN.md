---
phase: 02.1-clear-announces-preserves-contacts
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt
  - app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt
autonomous: true

must_haves:
  truths:
    - "DAO test proves SQL subquery correctly deletes non-contact announces"
    - "DAO test proves SQL subquery correctly preserves contact announces for the active identity"
    - "DAO test proves contacts from other identities do NOT prevent deletion"
    - "DAO test proves empty contacts table results in all announces being deleted"
    - "ViewModel test proves deleteAllAnnounces calls new method with correct identity hash"
    - "ViewModel test proves fallback to deleteAllAnnounces when no active identity"
  artifacts:
    - path: "data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt"
      provides: "DAO-level tests for deleteAllAnnouncesExceptContacts SQL query"
      contains: "deleteAllAnnouncesExceptContacts"
    - path: "app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt"
      provides: "ViewModel-level tests for identity-aware delete routing"
      contains: "deleteAllAnnouncesExceptContacts"
  key_links:
    - from: "AnnounceDaoTest"
      to: "AnnounceDao.deleteAllAnnouncesExceptContacts()"
      via: "In-memory Room database with real SQL execution"
      pattern: "dao.deleteAllAnnouncesExceptContacts"
    - from: "AnnounceStreamViewModelTest"
      to: "AnnounceStreamViewModel.deleteAllAnnounces()"
      via: "MockK verification of repository method calls"
      pattern: "announceRepository.deleteAllAnnouncesExceptContacts"
---

<objective>
Add tests for the contact-preserving announce deletion behavior.

Purpose: Verify that the SQL subquery correctly preserves contact announces, deletes non-contact announces, and handles edge cases (no contacts, other identities, no active identity). These tests protect against regressions and validate the SQL query logic.

Output: DAO tests in AnnounceDaoTest.kt (using real in-memory Room database) and ViewModel tests in AnnounceStreamViewModelTest.kt (using MockK).
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-clear-announces-preserves-contacts/02.1-RESEARCH.md
@.planning/phases/02.1-clear-announces-preserves-contacts/02.1-01-SUMMARY.md
@data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt
@app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt
@data/src/main/java/com/lxmf/messenger/data/db/entity/ContactEntity.kt
@data/src/main/java/com/lxmf/messenger/data/db/entity/AnnounceEntity.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DAO tests for deleteAllAnnouncesExceptContacts</name>
  <files>
    data/src/test/java/com/lxmf/messenger/data/db/dao/AnnounceDaoTest.kt
  </files>
  <action>
    Add tests to the existing AnnounceDaoTest.kt file. These tests use the real in-memory Room database (Robolectric) to validate the SQL query behavior. The test file already has `database` and `dao` (AnnounceDao) set up. You need to additionally get `contactDao` from the database for inserting test contacts.

    Add `import com.lxmf.messenger.data.db.entity.ContactEntity` to imports.
    Add `import com.lxmf.messenger.data.db.entity.LocalIdentityEntity` to imports.
    Add a `contactDao` property initialized in `setup()`: `contactDao = database.contactDao()`.
    Add an `identityDao` property for inserting identity (needed for FK constraint): Get the identity DAO from database to insert the test identity entity before contacts can reference it.

    **IMPORTANT**: ContactEntity has a foreign key on `identityHash` referencing `local_identities.identityHash`. You MUST insert a `LocalIdentityEntity` first before inserting any contacts, otherwise the FK constraint will fail. Check ColumbaDatabase for the identity DAO accessor name.

    Add a helper function for creating test contacts:
    ```kotlin
    private fun createTestContact(
        destinationHash: String,
        identityHash: String = "test_identity_hash",
    ) = ContactEntity(
        destinationHash = destinationHash,
        identityHash = identityHash,
        publicKey = ByteArray(32) { it.toByte() },
        addedTimestamp = System.currentTimeMillis(),
        addedVia = "ANNOUNCE",
    )
    ```

    Add a helper function for creating the required test identity:
    ```kotlin
    private fun createTestIdentity(
        identityHash: String = "test_identity_hash",
    ) = LocalIdentityEntity(
        identityHash = identityHash,
        displayName = "Test Identity",
        destinationHash = "dest_$identityHash",
        filePath = "/test/path",
        createdTimestamp = System.currentTimeMillis(),
        lastUsedTimestamp = System.currentTimeMillis(),
        isActive = true,
    )
    ```

    Add a new test section `// ========== deleteAllAnnouncesExceptContacts Tests ==========` with these tests:

    **Test 1: `deleteAllAnnouncesExceptContacts_removesNonContactAnnounces`**
    - Insert 2 announces (dest_hash_1, dest_hash_2) and a LocalIdentityEntity + 1 contact for dest_hash_1
    - Call `dao.deleteAllAnnouncesExceptContacts("test_identity_hash")`
    - Assert: Only dest_hash_1 remains (1 announce), dest_hash_2 was deleted

    **Test 2: `deleteAllAnnouncesExceptContacts_preservesAllContactAnnounces`**
    - Insert 3 announces and a LocalIdentityEntity + contacts for all 3
    - Call `dao.deleteAllAnnouncesExceptContacts("test_identity_hash")`
    - Assert: All 3 announces remain

    **Test 3: `deleteAllAnnouncesExceptContacts_doesNotPreserveContactsFromOtherIdentities`**
    - Insert 2 announces, 2 LocalIdentityEntities ("identity_A" and "identity_B")
    - Add contact for dest_hash_1 under identity_B (NOT the active identity)
    - Call `dao.deleteAllAnnouncesExceptContacts("identity_A")` (identity_A has NO contacts)
    - Assert: Both announces are deleted (0 remaining) because identity_A has no contacts

    **Test 4: `deleteAllAnnouncesExceptContacts_deletesAllWhenNoContacts`**
    - Insert 3 announces, no contacts (but DO insert a LocalIdentityEntity for the FK if needed, or just pass a hash that has no contacts)
    - Call `dao.deleteAllAnnouncesExceptContacts("some_identity_with_no_contacts")`
    - Assert: All announces deleted (0 remaining)

    **Test 5: `deleteAllAnnouncesExceptContacts_handlesEmptyAnnouncesTable`**
    - No announces inserted
    - Call `dao.deleteAllAnnouncesExceptContacts("test_identity_hash")`
    - Assert: No crash, `getAllAnnouncesSync()` returns empty list

    **Test 6: `deleteAllAnnounces_stillDeletesEverything`** (regression test)
    - Insert 2 announces and a LocalIdentityEntity + 1 contact for dest_hash_1
    - Call `dao.deleteAllAnnounces()` (the OLD method)
    - Assert: All announces deleted (0 remaining) - original behavior unchanged

    Use `runTest { }` for all tests. Use `dao.getAllAnnouncesSync()` to check remaining announces after deletion.
  </action>
  <verify>
    Run the DAO tests:
    ```bash
    JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:testDebugUnitTest --tests "com.lxmf.messenger.data.db.dao.AnnounceDaoTest"
    ```
    All tests should pass, including the new deleteAllAnnouncesExceptContacts tests.
  </verify>
  <done>
    6 new DAO tests added covering: non-contact deletion, contact preservation, identity scoping, empty contacts, empty announces, and regression of original deleteAllAnnounces. All pass against real in-memory Room database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ViewModel tests for identity-aware delete routing</name>
  <files>
    app/src/test/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModelTest.kt
  </files>
  <action>
    Update the existing AnnounceStreamViewModelTest.kt to add tests for the updated `deleteAllAnnounces()` behavior. The test file already mocks `identityRepository` and `announceRepository`.

    First, add mock setup for the new repository method in the `@Before setup()` method:
    ```kotlin
    coEvery { announceRepository.deleteAllAnnouncesExceptContacts(any()) } just Runs
    ```

    Then update the existing `deleteAllAnnounces calls repository` test and the `deleteAllAnnounces handles errors gracefully` test to reflect the new behavior (they currently verify the old `deleteAllAnnounces()` is called, but now `deleteAllAnnouncesExceptContacts()` should be called instead since `testLocalIdentity` is returned by default).

    **Update existing test: `deleteAllAnnounces calls repository`** (around line 868)
    - The mock setup already returns `testLocalIdentity` for `getActiveIdentitySync()` (line 132)
    - Change verification from `coVerify { announceRepository.deleteAllAnnounces() }` to:
      ```kotlin
      coVerify { announceRepository.deleteAllAnnouncesExceptContacts(testLocalIdentity.identityHash) }
      coVerify(exactly = 0) { announceRepository.deleteAllAnnounces() }
      ```
    - Update test name to: `` `deleteAllAnnounces preserves contact announces via identity-aware delete` ``

    **Update existing test: `deleteAllAnnounces handles errors gracefully`** (around line 884)
    - Change the mock to throw from the new method:
      ```kotlin
      coEvery { announceRepository.deleteAllAnnouncesExceptContacts(any()) } throws Exception("Database error")
      ```
    - Update verification:
      ```kotlin
      coVerify { announceRepository.deleteAllAnnouncesExceptContacts(testLocalIdentity.identityHash) }
      ```

    **Add new test: `deleteAllAnnounces falls back to deleteAll when no active identity`**
    - Override identity mock: `coEvery { identityRepository.getActiveIdentitySync() } returns null`
    - Call `viewModel.deleteAllAnnounces()`
    - Verify: `coVerify { announceRepository.deleteAllAnnounces() }` (old method called)
    - Verify: `coVerify(exactly = 0) { announceRepository.deleteAllAnnouncesExceptContacts(any()) }` (new method NOT called)

    Place the new test in the existing `// ========== Delete Announce Tests ==========` section.
  </action>
  <verify>
    Run the ViewModel tests:
    ```bash
    JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:testDebugUnitTest --tests "com.lxmf.messenger.viewmodel.AnnounceStreamViewModelTest"
    ```
    All tests should pass, including the updated and new deleteAllAnnounces tests.
  </verify>
  <done>
    2 existing ViewModel tests updated to verify identity-aware delete routing.
    1 new ViewModel test added for null-identity fallback behavior.
    All ViewModel tests pass.
  </done>
</task>

</tasks>

<verification>
1. All DAO tests pass: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:testDebugUnitTest --tests "com.lxmf.messenger.data.db.dao.AnnounceDaoTest"`
2. All ViewModel tests pass: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:testDebugUnitTest --tests "com.lxmf.messenger.viewmodel.AnnounceStreamViewModelTest"`
3. Full test suite passes: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew testDebugUnitTest`
4. Code quality: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew detektCheck`
</verification>

<success_criteria>
- 6 new DAO tests verify SQL query behavior with real Room database
- 2 existing ViewModel tests updated for new behavior
- 1 new ViewModel test covers null-identity fallback
- All tests execute production code (no mock-only tests)
- Full test suite passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-clear-announces-preserves-contacts/02.1-02-SUMMARY.md`
</output>
