---
phase: 02.1-clear-announces-preserves-contacts
plan: 01
subsystem: database
tags: [room, sql, dao, repository, viewmodel, compose-ui]

# Dependency graph
requires:
  - phase: contacts
    provides: contacts table with identityHash and destinationHash linking
provides:
  - Identity-aware announce deletion via SQL subquery
  - Contact preservation in Clear All Announces feature
affects: [user-experience, data-management, contacts]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - SQL subquery with NOT IN for contact-aware filtering
    - Identity-scoped data operations with fallback for missing identity

key-files:
  created: []
  modified:
    - data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt
    - data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt
    - app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt
    - app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt

key-decisions:
  - "Use SQL subquery (NOT IN) for contact filtering instead of joining tables"
  - "Preserve original deleteAllAnnounces() for backward compatibility and testing"
  - "Fall back to deleteAllAnnounces() if no active identity (edge case during identity switching)"
  - "Update dialog text to inform users about contact preservation"

patterns-established:
  - "Identity-aware database operations: get active identity, use identity-scoped method, fallback for null identity"
  - "Room DAO methods scoped by identityHash parameter to filter by active user"

# Metrics
duration: 3min
completed: 2026-01-27
---

# Phase 02.1 Plan 01: Clear Announces Preserves Contacts Summary

**Identity-aware announce deletion via SQL subquery preserves contact announces, fixing "Node not found" errors when opening conversations with saved contacts**

## Performance

- **Duration:** 2 min 58 sec
- **Started:** 2026-01-28T02:35:33Z
- **Completed:** 2026-01-28T02:38:31Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- "Clear All Announces" now preserves announces belonging to contacts in My Contacts
- Users can still open new conversations with saved contacts after clearing announces
- SQL subquery filters by identity to ensure only the active identity's contacts are preserved
- Falls back gracefully when no active identity exists (edge case during identity switching)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add identity-aware delete to DAO and Repository layers** - `38dfb9fa` (feat)
2. **Task 2: Update ViewModel and UI dialog to preserve contacts** - `8832b6e4` (feat)

## Files Created/Modified
- `data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt` - Added deleteAllAnnouncesExceptContacts(identityHash) with SQL subquery
- `data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt` - Added repository passthrough method
- `app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt` - Updated deleteAllAnnounces() to use identity-aware method with fallback
- `app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt` - Updated dialog text to mention contact preservation

## Decisions Made

- **SQL subquery approach:** Used `DELETE FROM announces WHERE destinationHash NOT IN (SELECT destinationHash FROM contacts WHERE identityHash = :identityHash)` instead of joins for clarity and performance
- **Backward compatibility:** Preserved original `deleteAllAnnounces()` method for testing and fallback scenarios
- **Identity fallback:** When no active identity exists (shouldn't happen in normal use), fall back to deleting all announces to prevent undefined behavior
- **User communication:** Updated dialog text to explicitly mention contact preservation so users understand the new behavior

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation proceeded smoothly. Room compiled the SQL query without errors, and all tests passed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Fix deployed and ready for testing
- Users can now safely clear announces without losing contact data
- No blockers for next phase
- Recommendation: Monitor for any edge cases where identity switching occurs during announce clearing

---
*Phase: 02.1-clear-announces-preserves-contacts*
*Completed: 2026-01-27*
