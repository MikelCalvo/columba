---
phase: 02.1-clear-announces-preserves-contacts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt
  - data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt
  - app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt
  - app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt
autonomous: true

must_haves:
  truths:
    - "Clear All Announces deletes non-contact announces"
    - "Clear All Announces preserves announces belonging to contacts in My Contacts"
    - "Dialog text reflects new behavior (mentions contacts are preserved)"
    - "Falls back to delete-all if no active identity (backward compatible)"
  artifacts:
    - path: "data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt"
      provides: "deleteAllAnnouncesExceptContacts(identityHash) SQL query"
      contains: "DELETE FROM announces WHERE destinationHash NOT IN"
    - path: "data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt"
      provides: "deleteAllAnnouncesExceptContacts(identityHash) passthrough"
      contains: "deleteAllAnnouncesExceptContacts"
    - path: "app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt"
      provides: "Updated deleteAllAnnounces() with identity-aware routing"
      contains: "identityRepository.getActiveIdentitySync"
    - path: "app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt"
      provides: "Updated dialog text mentioning contact preservation"
      contains: "except those saved in My Contacts"
  key_links:
    - from: "AnnounceStreamViewModel.deleteAllAnnounces()"
      to: "AnnounceRepository.deleteAllAnnouncesExceptContacts()"
      via: "identityRepository.getActiveIdentitySync() provides identityHash"
      pattern: "deleteAllAnnouncesExceptContacts.*identityHash"
    - from: "AnnounceRepository.deleteAllAnnouncesExceptContacts()"
      to: "AnnounceDao.deleteAllAnnouncesExceptContacts()"
      via: "Direct delegation"
      pattern: "announceDao.deleteAllAnnouncesExceptContacts"
---

<objective>
Fix "Clear All Announces" to preserve announces belonging to contacts in My Contacts.

Purpose: Users who tap "Clear All Announces" currently lose all announce data including contacts, which breaks the ability to open new conversations with saved contacts (causing "Node not found" errors). This fix exempts contact announces from the bulk delete.

Output: Updated DAO query, repository method, ViewModel logic, and dialog text across 4 files.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-clear-announces-preserves-contacts/02.1-RESEARCH.md
@data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt
@data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt
@app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt
@app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add identity-aware delete to DAO and Repository layers</name>
  <files>
    data/src/main/java/com/lxmf/messenger/data/db/dao/AnnounceDao.kt
    data/src/main/java/com/lxmf/messenger/data/repository/AnnounceRepository.kt
  </files>
  <action>
    **AnnounceDao.kt:** Add a new method `deleteAllAnnouncesExceptContacts(identityHash: String)` immediately AFTER the existing `deleteAllAnnounces()` method (after line 132). Keep the original `deleteAllAnnounces()` unchanged (used for tests and fallback). The new method uses a SQL subquery:

    ```kotlin
    /**
     * Delete all announces except those belonging to contacts of the specified identity.
     * Preserves contact announces so users can still open conversations with saved contacts.
     *
     * @param identityHash The identity hash to filter contacts by
     */
    @Query("""
        DELETE FROM announces
        WHERE destinationHash NOT IN (
            SELECT destinationHash
            FROM contacts
            WHERE identityHash = :identityHash
        )
    """)
    suspend fun deleteAllAnnouncesExceptContacts(identityHash: String)
    ```

    IMPORTANT: The subquery MUST include `WHERE identityHash = :identityHash` to scope by the active identity. Without this, contacts from OTHER identities would also be preserved, which is incorrect.

    **AnnounceRepository.kt:** Add a new method `deleteAllAnnouncesExceptContacts(identityHash: String)` immediately AFTER the existing `deleteAllAnnounces()` method (after line 399). It simply delegates to the DAO:

    ```kotlin
    /**
     * Delete all announces except those belonging to contacts of the specified identity.
     * Preserves contact announces so users can still open conversations with saved contacts.
     *
     * @param identityHash The identity hash to filter contacts by
     */
    suspend fun deleteAllAnnouncesExceptContacts(identityHash: String) {
        announceDao.deleteAllAnnouncesExceptContacts(identityHash)
    }
    ```
  </action>
  <verify>
    Build the data module to verify Room compiles the new SQL query:
    ```bash
    JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :data:compileDebugKotlin
    ```
    The build should succeed without Room SQL compilation errors.
  </verify>
  <done>
    AnnounceDao has `deleteAllAnnouncesExceptContacts(identityHash)` with correct SQL subquery.
    AnnounceRepository has matching passthrough method.
    Original `deleteAllAnnounces()` is preserved in both files for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ViewModel and UI dialog to use identity-aware delete</name>
  <files>
    app/src/main/java/com/lxmf/messenger/viewmodel/AnnounceStreamViewModel.kt
    app/src/main/java/com/lxmf/messenger/ui/screens/AnnounceStreamScreen.kt
  </files>
  <action>
    **AnnounceStreamViewModel.kt:** Replace the `deleteAllAnnounces()` method (lines 476-485) with an identity-aware version. The ViewModel already has `identityRepository` injected (line 47). The new implementation:

    1. Gets the active identity via `identityRepository.getActiveIdentitySync()`
    2. If identity exists, calls `announceRepository.deleteAllAnnouncesExceptContacts(identityHash)`
    3. If identity is null (edge case during identity switching), falls back to `announceRepository.deleteAllAnnounces()` for backward compatibility
    4. Updates log messages to reflect the new behavior

    Replace the method body:
    ```kotlin
    /**
     * Delete all announces from the database, except those belonging to saved contacts.
     * Preserves announces for contacts so users can still open conversations.
     * Nodes will reappear when they announce again.
     */
    fun deleteAllAnnounces() {
        viewModelScope.launch {
            try {
                val activeIdentity = identityRepository.getActiveIdentitySync()
                if (activeIdentity != null) {
                    announceRepository.deleteAllAnnouncesExceptContacts(activeIdentity.identityHash)
                    Log.d(TAG, "Deleted non-contact announces for identity: ${activeIdentity.identityHash}")
                } else {
                    // Fallback: delete all if no active identity (shouldn't happen in normal use)
                    announceRepository.deleteAllAnnounces()
                    Log.d(TAG, "Deleted all announces (no active identity)")
                }
            } catch (e: Exception) {
                Log.e(TAG, "Failed to delete announces", e)
            }
        }
    }
    ```

    **AnnounceStreamScreen.kt:** Update the dialog text (around line 856) to reflect the new behavior. Change:
    ```
    "This will remove all discovered nodes from the list. They will reappear when they announce again."
    ```
    To:
    ```
    "This will remove all discovered nodes from the list, except those saved in My Contacts. Nodes will reappear when they announce again."
    ```
    This is a single string change in the `text` lambda of the AlertDialog.
  </action>
  <verify>
    Build the full app to verify everything compiles:
    ```bash
    JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew :app:compileDebugKotlin
    ```
    The build should succeed.
  </verify>
  <done>
    ViewModel's `deleteAllAnnounces()` now routes through `deleteAllAnnouncesExceptContacts()` when an active identity exists.
    Falls back to original `deleteAllAnnounces()` when no active identity.
    Dialog text updated to inform users that contacts are preserved.
  </done>
</task>

</tasks>

<verification>
1. Full project build passes: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew assembleDebug`
2. Existing tests pass: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew testDebugUnitTest`
3. Code quality checks pass: `JAVA_HOME=/home/tyler/android-studio/jbr ./gradlew detektCheck`
</verification>

<success_criteria>
- AnnounceDao has `deleteAllAnnouncesExceptContacts(identityHash)` with SQL subquery that excludes contacts for the given identity
- AnnounceRepository exposes matching method
- AnnounceStreamViewModel.deleteAllAnnounces() uses identity-aware method with null-identity fallback
- Dialog text mentions contact preservation
- All existing tests still pass
- Project builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-clear-announces-preserves-contacts/02.1-01-SUMMARY.md`
</output>
